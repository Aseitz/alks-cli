#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

var program   = require('commander'),
    _         = require('underscore'),
    clc       = require('cli-color'),
    opn       = require('opn'),
    alks      = require('../lib/alks-api'),
    iam       = require('../lib/iam'),
    utils     = require('../lib/utils'),
    config    = require('../package.json');

var logger       = 'iam-console';

program
    .version(config.version)
    .description('open an AWS console in your browser to preform IAM functions')
    .option('-o, --openWith [appName]', 'open in a different app (optional)')
    .option('-a, --account [alksAccount]', 'alks account to use')
    .option('-r, --role [alksRole]', 'alks role to use')
    .option('-v, --verbose', 'be verbose')
    .parse(process.argv);

var alksAccount     = program.account,
    alksRole        = program.role,
    hasAlksAcctRole = !_.isEmpty(alksAccount) && !_.isEmpty(alksRole);

iam.getIAMKey(program, logger, hasAlksAcctRole, alksAccount, alksRole, function(err, key, developer, password){
    if(err){
        return utils.errorAndExit(err);
    }

    if(!_.isEmpty(key.consoleURL)){
        var opts = !_.isEmpty(program.openWith) ? { app: program.openWith } : {};

        opn(key.consoleURL, opts);
    }
    else{
        console.error(clc.red('The selected key does not have a console URL.'));
    }

    utils.log(program, logger, 'checking for updates');
    utils.checkForUpdate();
});