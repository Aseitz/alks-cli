#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

var program    = require('commander'),
    clc        = require('cli-color'),
    _          = require('underscore'),
    config     = require('../package.json'),
    utils      = require('../lib/utils'),
    Keys       = require('../lib/keys'),
    Developer  = require('../lib/developer'),
    Sessions   = require('../lib/sessions');

var outputValues = utils.getOutputValues();

program
    .version(config.version)
    .description('creates or resumes a session')
    .option('-a, --account [alksAccount]', 'alks account to use')
    .option('-r, --role [alksRole]', 'alks role to use')
    .option('-p, --password [password]', 'my password')
    .option('-o, --output [format]', 'output format (' + outputValues.join(', ') + '), default: ' + outputValues[0], outputValues[0])
    .option('-n, --namedProfile [profile]', 'if output is set to creds, use this profile, default: default')
    .option('-f, --force', 'if output is set to creds, force overwriting of AWS credentials')
    .option('-v, --verbose', 'be verbose')
    .parse(process.argv);

var alksAccountIdx    = program.args[0],
    alksAccountIdxInt = parseInt(alksAccountIdx),
    alksAccount       = program.account,
    alksRole          = program.role,
    hasAlksAcctRole   = !_.isEmpty(alksAccount) && !_.isEmpty(alksRole),
    output            = program.output,
    logger            = 'sessions-open';

if(program.args[0] && (isNaN(alksAccountIdxInt) || alksAccountIdxInt < 1)){
    utils.errorAndExit('ALKS Account ID should be a positive integer.');
}
else if(!isNaN(alksAccountIdxInt)){
    alksAccountIdx = alksAccountIdxInt - 1;
}
else if(isNaN(alksAccountIdxInt)){
    alksAccountIdx = null;
}

Sessions.getSessionKey(program, logger, hasAlksAcctRole, alksAccount, alksRole, alksAccountIdx, false, function(err, key, developer, password){
    if(err){
        return utils.errorAndExit(err);
    }

    console.error('');
    console.log(Keys.getKeyOutput(output, key, program.namedProfile, program.force));

    utils.log(program, logger, 'checking for updates');
    utils.checkForUpdate();
});