#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

var program  = require('commander'),
    clc      = require('cli-color'),
    async    = require('async'),
    _        = require('underscore'),
    inquirer = require('inquirer'),
    config   = require('../package.json'),
    utils    = require('../lib/utils'),
    keys     = require('../lib/keys'),
    Account  = require('../lib/account'),
    alks     = require('../lib/alks-api');

program
    .version(config.version)
    .description('creates or resumes a session')
    .parse(process.argv);

// TODO: how to make this not require input? dont want to have to pass that long-ass ALKS account string in
// TODO: output values
async.waterfall([
    // check to be sure were configured
    function(callback){
        Account.ensureConfigured(callback);
    },
    // get alks account
    function(callback){
        Account.getALKSAccount(program, callback);
    },
    // now retrieve existing keys
    function(alksAccount, callback){
        console.log('getting keys')
        keys.getKeys(alksAccount.password, function(err, keys){
            console.log('got keys')
            callback(null, alksAccount, keys);
        });
    },
    // look for existing session
    function(alksAccount, keys, callback){
        // TODO: find existing session, if none create eone
        // TODO: return session keys
        console.log(JSON.stringify(alksAccount), JSON.stringify(keys))
    }
], function(err, data){
    if(err){
        utils.errorAndExit(err);
    }

    // TODO: output session keys, follow output format of keys create

    utils.checkForUpdate();
});