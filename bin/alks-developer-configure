#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

var program  = require('commander'),
    clc      = require('cli-color'),
    prompt   = require('prompt'),
    inquirer = require('inquirer'),
    async    = require('async'),
    _        = require('underscore'),
    config   = require('../package.json'),
    utils    = require('../lib/utils'),
    Account  = require('../lib/account'),
    alks     = require('../lib/alks-api');

program
    .version(config.version)
    .description('configures developer')
    .parse(process.argv);

function getPrompt(field, data, text, callback){
    var promptConfig = {
        name: field,
        description: text,
        required: true
    };
    if(!_.isEmpty(data[field])){
        promptConfig.default = data[field];
    }

    prompt.start();
    prompt.message = '';
    prompt.get([ promptConfig ], function(err, result){
        if(err){
            callback(err);
        }
        else{
            callback(null, result[field]);
        }
    });    
}

async.waterfall([
    function(callback){
        Account.getAccount(callback);
    },
    function(previousData, callback){
        getPrompt('server', previousData, 'ALKS server', function(err, server){
            callback(err, previousData, server);
        });
    },
    function(previousData, server, callback){
        getPrompt('userid', previousData, 'Network Username', function(err, userid){
            callback(err, previousData, server, userid);
        });
    },
    function(previousData, server, userid, callback){
        Account.getPasswordFromPrompt(function(err, password){
            callback(err, previousData, server, userid, password);
        }, 'Network Password', true);
    },
    function(previousData, server, userid, password, callback){
        inquirer.prompt([
            {
                type: 'list',
                name: 'savePassword',
                message: 'Save password',
                choices: [ 'Yes', 'No' ]
            }
        ]).then(function(answers){
            callback(null, previousData, server, userid, password, answers.savePassword);
        });        
    },
    function(previousData, server, userid, password, savePassword, callback){
        alks.getAccounts(server, userid, password, function(err, accounts){
            callback(err, server, userid, password, savePassword, accounts);
        })
    },
    function(server, userid, password, savePassword, alksAccounts, callback){
        inquirer.prompt([
            {
                type: 'list',
                name: 'alksAccount',
                message: 'Please select an ALKS account/role',
                choices: alksAccounts
            }
        ]).then(function(answers){
            var data = answers.alksAccount.split(alks.getAccountSelectorDelimiter()),
                alksAccount = data[0],
                alksRole = data[1];

            callback(null, server, userid, password, savePassword, alksAccount, alksRole);
        });
    }
], function(err, server, userid, password, savePassword, alksAccount, alksRole){
    if(err){
        return utils.errorAndExit('Error configuring account!', err);
    }

    var accountPayload = {
        server: server,
        userid: userid,
        password: password,
        savePassword: savePassword,
        alksAccount: alksAccount,
        alksRole: alksRole
    };

    Account.saveAccount(accountPayload, function(err){
        if(err){
            console.error(clc.red.bold('Error saving account!'));
        }
        else{
            console.error(clc.white('Account saved!'));
        }
    });
});