#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

var program  = require('commander'),
    clc      = require('cli-color'),
    async    = require('async'),
    _        = require('underscore'),
    config   = require('../package.json'),
    utils    = require('../lib/utils'),
    Account  = require('../lib/account');

program
    .version(config.version)
    .description('switches alks account')
    .parse(process.argv);

async.waterfall([
    // check to be sure were configured
    function(callback){
        Account.ensureConfigured(callback);
    },
    // get account
    function(callback){
        Account.getAccount(callback);
    },
    // get alks account
    function(account, callback){
        Account.getALKSAccount(program, function(err, alksAccount){
            callback(err, account, alksAccount.account, alksAccount.role);
        });
    },
    // update user account
    function(account, alksAccount, alksRole, callback){
        var accountPayload = _.extend(account, {
            alksAccount: alksAccount,
            alksRole: alksRole
        });

        Account.saveAccount(accountPayload, function(err){
            if(err){
                console.error(clc.red.bold('Error switching account!'), err);
            }
            else{
                console.error(clc.white('Your account is now set to %s - %s'), alksAccount, alksRole);
                callback(null);
            }
        });
    }
], function(err, data){
    if(err){
        utils.errorAndExit(err);
    }

    utils.checkForUpdate();
});