#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

var program  = require('commander'),
    clc      = require('cli-color'),
    async    = require('async'),
    _        = require('underscore'),
    inquirer = require('inquirer'),
    config   = require('../package.json'),
    utils    = require('../lib/utils'),
    account  = require('../lib/account'),
    alks     = require('../lib/alks-api');

program
    .version(config.version)
    .description('switches alks account')
    .parse(process.argv);

async.waterfall([
    // check to be sure were configured
    function(callback){
        account.ensureConfigured(function(err, data){
            if(err) utils.errorAndExitNoConfig();
            else callback(null);
        });        
    },    
    function(callback){
        account.getPassword(program, callback);
    },
    function(password, callback){
        alks.getAccounts(password, callback);
    },
    function(accounts, callback){
        inquirer.prompt([
            {
                type: 'list',
                name: 'account',
                message: 'Please select an account/role',
                choices: accounts
            }
        ]).then(function(answers){
            callback(null, answers.account);
        });
    },
    function(accountToSwitchTo, callback){
        // TODO: switch account, derp!
        
        console.error(clc.white('Your account is now set to %s'), accountToSwitchTo);
        callback(null);
    }
], function(err, data){
    if(err){
        utils.errorAndExit(err);
    }
});